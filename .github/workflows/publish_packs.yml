name: Publish Packs OCI

on:
  push:
    branches:
      - master
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to publish (defaults to git tag or workspace version)"
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      RUSTUP_TOOLCHAIN: 1.90.0
      PACK_VERSION: "0.4"
      REGISTRY: ghcr.io
      OWNER: greentic-ai
      REPO: greentic-packs
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ env.RUSTUP_TOOLCHAIN }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.90.0
          override: true

      - name: Install wasm32-wasip2 target
        run: rustup target add wasm32-wasip2 --toolchain "${RUSTUP_TOOLCHAIN}"
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install greentic-pack (skip if cached)
        run: |
          if ! command -v greentic-pack >/dev/null 2>&1 || [[ "$(greentic-pack --version)" != greentic-pack\ ${PACK_VERSION}* ]]; then
            cargo binstall greentic-pack --force --locked -y
          fi

      - name: Build pack artifacts
        env:
          PACK_SERIES: "${{ env.PACK_VERSION }}."
        run: bash scripts/build_packs.sh

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install ORAS
        uses: oras-project/setup-oras@v1
        with:
          version: "1.2.0"

      - name: Login to GHCR
        env:
          CR_PAT: ${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "${CR_PAT}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Publish packs to GHCR
        env:
          VERSION: ${{ github.event.inputs.version }}
          REGISTRY: ${{ env.REGISTRY }}
          OWNER: ${{ env.OWNER }}
          REPO: ${{ env.REPO }}
          GITHUB_SHA: ${{ github.sha }}
          MAKE_PUBLIC: "true"
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}
          VISIBILITY_ENDPOINT: "user"
        run: bash scripts/publish_packs_oci.sh
