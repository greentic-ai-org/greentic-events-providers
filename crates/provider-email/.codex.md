# provider-email Codex

You are the **provider-email** Codex in the `greentic-events-providers` workspace.

## Purpose

Provide **email-based event providers** as WASM components + packs:

- `events-email-source@1.0.0` – `source` world:
  - Emits events for incoming email.
- `events-email-sink@1.0.0` – `sink` world:
  - Sends email based on incoming `EventEnvelope` (outbound notifications).

Providers may use **Microsoft Graph** and **Gmail/Google Workspace** via greentic-oauth-sdk and greentic-secrets.

## Dependencies

- `provider-core`
- `greentic-types`
- `greentic-interfaces-guest` (events worlds)
- `greentic-oauth-sdk` (for access tokens)
- `greentic-secrets` (for SMTP/user-specifics if needed)
- `serde`, `serde_json`, `chrono`

## Tasks

### 1. Topic conventions

Standardise topics:

- Inbound email:
  - `email.in.msgraph.<folder>` – e.g. `email.in.msgraph.inbox`.
  - `email.in.gmail.<label>` – e.g. `email.in.gmail.support`.
- Outbound email:
  - `email.out.msgraph`
  - `email.out.gmail`

Make these only **conventions**; do not hardcode any domain semantics beyond naming.

### 2. `events-email-source@1.0.0` (source)

Implement a component that:

- Receives config (e.g. tenant-specific folder/label to watch; provider name: `msgraph` or `gmail`).
- Is invoked by the host when:
  - an email arrives (polling or webhook integration handled by host/deployer),
  - or on a schedule to pull new messages.

For each email:

- Map to an `EventEnvelope` with:
  - `topic`: `email.in.<provider>.<folder_or_label>`
  - `type_`: `"com.greentic.email.generic.v1"`
  - `source`: `"email-provider"`
  - `subject`: e.g. `Some(message_id_or_subject)`
  - `payload`: JSON representation of the email (headers, subject, body, from, to, etc.).
  - `metadata`: keys like `provider`, `folder`, `message_id`.

Leverage `provider-core` helpers to build envelopes.

### 3. `events-email-sink@1.0.0` (sink)

Implement a component that:

- Accepts an `EventEnvelope` with `topic` `email.out.msgraph` or `email.out.gmail`.
- Reads:
  - `to`, `subject`, `body` (and optional CC/BCC) from the `payload` JSON.
- Uses:
  - `greentic-oauth-sdk` to obtain access tokens (for MS Graph / Gmail) based on `TenantCtx` + provider id.
  - Or SMTP credentials via `greentic-secrets` where appropriate.

For v1, focus on:

- MS Graph send messages (app-only client credentials).
- Optionally Gmail via SMTP or Gmail API if you want.

### 4. Packs

Under `packs/events/email.yaml`, define entries like:

```yaml
events:
  providers:
    - name: "email-in-msgraph"
      kind: "source"
      component: "events-email-source@1.0.0"
      capabilities:
        transport: "msgraph"
        reliability: "at_least_once"
        topics:
          - "email.in.msgraph.*"
    - name: "email-out-msgraph"
      kind: "sink"
      component: "events-email-sink@1.0.0"
      capabilities:
        transport: "msgraph"
        reliability: "at_least_once"
        topics:
          - "email.out.msgraph"
    - name: "email-in-gmail"
      kind: "source"
      component: "events-email-source@1.0.0"
      capabilities:
        transport: "gmail"
        reliability: "at_least_once"
        topics:
          - "email.in.gmail.*"
    - name: "email-out-gmail"
      kind: "sink"
      component: "events-email-sink@1.0.0"
      capabilities:
        transport: "gmail"
        reliability: "at_least_once"
        topics:
          - "email.out.gmail"
```

### 5. Flows
Add minimal flows under flows/events/email/:
- `in_default.ygtc`: email source → greentic-events.
- `out_default.ygtc`: event from some flow → email sink.
- Flows can be placeholders; they just need to be valid and match pack paths.

### 6. Tests
Unit tests:
- Given a sample email (minimal JSON), events-email-source mapping produces expected EventEnvelope.
- Given an outbound EventEnvelope with email.out.msgraph, events-email-sink builds a correct “send request” payload (even if actual HTTP call is stubbed).

Pack consistency test:
- YAML parses and matches the component IDs.

## Constraints
- No direct HTTP calls inside WASM; actual Graph/Gmail HTTP is host responsibility where needed.
- No user/domain-specific semantics; treat email as generic messages.
