# provider-core Codex

You are the **provider-core** Codex in the `greentic-events-providers` workspace.

## Purpose

`provider-core` provides **shared types and utilities** for all provider crates:

- Common config structures (HTTP endpoint configs, schedule configs).
- Helpers for constructing `EventEnvelope` and handling `TenantCtx`.
- Shared idempotency and metadata helpers.
- Integration helpers for `greentic-secrets` and `greentic-oauth-sdk` (for email providers).

This crate must be **WASM-friendly** (no platform-specific syscalls, no raw sockets).

## Dependencies

- `greentic-types = "0.4"` (for `EventEnvelope`, `TenantCtx`, etc.).
- `serde`, `serde_json`, `chrono`, `uuid`, `thiserror`.
- Optional (behind features) hooks into:
  - `greentic-secrets` (for secrets lookups).
  - `greentic-oauth-sdk` (for email providers that need Graph/Gmail tokens).

## Tasks

### 1. Shared config types

Add config types in `src/config.rs` (or similar):

- `HttpEndpointConfig`:

  ```rust
  #[derive(Clone, Debug, Serialize, Deserialize)]
  pub struct HttpEndpointConfig {
      pub base_path: String,          // e.g. "/webhook"
      pub routes: Vec<WebhookRoute>,
  }

  #[derive(Clone, Debug, Serialize, Deserialize)]
  pub struct WebhookRoute {
      pub path: String,               // e.g. "/stripe", "/github"
      pub secret_ref: Option<String>, // e.g. "events/webhook/<tenant>/stripe"
      pub topic_prefix: String,       // e.g. "webhook.stripe"
  }
```

SchedulerConfig and Schedule:

```rust
#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct SchedulerConfig {
    pub schedules: Vec<Schedule>,
}

#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct Schedule {
    pub name: String,
    pub cron: String,               // cron expression or interval spec
    pub topic: String,              // e.g. "timer.daily.report"
    pub payload: serde_json::Value,
}
```

### 2. EventEnvelope helpers
Introduce a module (e.g. src/events.rs) with helpers:
fn new_event(...) -> EventEnvelope to build envelopes with:

- topic, type_, source, tenant, subject, correlation_id, payload, metadata.
- Automatically sets time = Utc::now() and an EventId (uuid).
- Helpers to set idempotency_key in metadata.

The goal is to give provider crates a consistent way to build envelopes.

### 3. Tenant & secrets helpers
Add a small module (e.g. src/tenant_secrets.rs) that offers:
fn tenant_key(tenant: &TenantCtx) -> String â€“ canonical "<env>/<tenant>/<team_or_underscore>".

Optional helper(s) for secrets keys:

fn events_provider_secret_key(tenant: &TenantCtx, provider_name: &str) -> String
 (align with greentic-secrets conventions, but do not depend directly on it yet).

If greentic-secrets is added as a dependency, provide an optional feature-gated helper:

fn fetch_secret(...) -> Result<SecretRecord, SecretError>.

### 4. Error types
Define a shared ProviderError enum:

```rust
#[derive(thiserror::Error, Debug)]
pub enum ProviderError {
    #[error("configuration error: {0}")]
    Config(String),
    #[error("authentication error: {0}")]
    Auth(String),
    #[error("transport error: {0}")]
    Transport(String),
    #[error("unexpected error: {0}")]
    Other(String),
}
```

Other crates should reuse this as their main error type.

### 5. Tests
- JSON round-trip tests for HttpEndpointConfig, SchedulerConfig.
- Basic tests for new_event helper:
  - required fields populated,
  - metadata/idempotency helpers work.

## Constraints
- No HTTP client or server code here.
- No WIT or greentic-interfaces usage here; that lives in provider crates.
- No domain logic (webhook/email/sms-specific logic belongs in their crates).
