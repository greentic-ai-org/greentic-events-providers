# provider-sms Codex

You are the **provider-sms** Codex in the `greentic-events-providers` workspace.

## Purpose

Provide Twilio-based **SMS event providers**:

- `events-sms-source@1.0.0` – `source` world:
  - Emits events for incoming SMS messages from Twilio webhooks.
- `events-sms-sink@1.0.0` – `sink` world:
  - Sends SMS messages via Twilio REST API based on EventEnvelope.

## Dependencies

- `provider-core`
- `greentic-types`
- `greentic-interfaces-guest` (events worlds)
- `greentic-secrets` (for Twilio credentials)
- `serde`, `serde_json`

## Tasks

### 1. Topic conventions

Use:

- Inbound SMS:
  - `sms.in.twilio.<phone_alias>` – e.g. `sms.in.twilio.support`.
- Outbound SMS:
  - `sms.out.twilio`

### 2. `events-sms-source@1.0.0` (source)

Component behaviour:

- Receives Twilio webhook payload via host (method, path, form/JSON body, headers).
- Config includes:
  - mapping from Twilio phone numbers → `phone_alias`.
  - optional signature secret for validation.

For each inbound SMS:

- Validate `X-Twilio-Signature` if configured (actual signature verification can be stubbed initially).
- Build an `EventEnvelope`:
  - `topic = "sms.in.twilio.<phone_alias>"`
  - `type_ = "com.greentic.sms.twilio.inbound.v1"`
  - `payload`: JSON with `from`, `to`, `body`, `message_sid`, etc.
  - `metadata`: Twilio-specific metadata, signature_valid flag, etc.

### 3. `events-sms-sink@1.0.0` (sink)

Component behaviour:

- Accepts an `EventEnvelope` with `topic` `sms.out.twilio`.
- Extracts:
  - `to`, `body`, and optionally `from` from the `payload`.
- Uses Twilio credentials from `greentic-secrets` (e.g. `events/sms/<tenant>/twilio` with account SID, auth token, default from number).
- Builds a Twilio REST API request representation (HTTP is done by host).

For v1 tests, it’s enough to **build and expose** the Twilio request structure; actual HTTP will be host-level.

### 4. Packs

`packs/events/sms.yaml`:

```yaml
events:
  providers:
    - name: "sms-in-twilio"
      kind: "source"
      component: "events-sms-source@1.0.0"
      capabilities:
        transport: "twilio"
        reliability: "at_least_once"
        topics:
          - "sms.in.twilio.*"
    - name: "sms-out-twilio"
      kind: "sink"
      component: "events-sms-sink@1.0.0"
      capabilities:
        transport: "twilio"
        reliability: "at_least_once"
        topics:
          - "sms.out.twilio"
```

### 5. Flows
Add flows/events/sms/in_default.ygtc and out_default.ygtc.
- Inbound: Twilio webhook → source → greentic-events.
- Outbound: some domain flow → sms-out provider.

### 6. Tests
Source:
- Given a sample Twilio webhook payload, verify the EventEnvelope fields.

Sink:
- Given an outbound EventEnvelope, verify a Twilio request structure.

Pack consistency.

## Constraints
- No direct HTTP client code; host does that.
- No domain semantics; treat SMS as generic text messages.
